<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Mime - A dummy Django, PyTorch project | Nomadin</title>
<meta name=keywords content><meta name=description content="What is this?
This is me goofing around and trying to learn some Django the only way there is, (by attempting to build something and combining it with a bunch of other things I know or have come across).
About
This is a Django-based &ldquo;web app&rdquo; that uses a Densenet 121 model trained to classify 6 classes of objects.
The Classes

Potholes
Dumping
Accidents
Flooded
Bad drainage
Construction

Data
The data was got from Duckduck go using jmd_imagecraper"><meta name=author content="Vince"><link rel=canonical href=https://mrdvince.github.io/posts/ckx8pdli806axz7s10sx5fy8c/><meta name=google-site-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.d7e0cf82c7928cf0c779a3f2e91e4634fd283070630f2ad5682f09edbf62aa03.css integrity="sha256-1+DPgseSjPDHeaPy6R5GNP0oMHBjDyrVaC8J7b9iqgM=" rel="preload stylesheet" as=style><link rel=icon href=https://mrdvince.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://mrdvince.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://mrdvince.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://mrdvince.github.io/apple-touch-icon.png><link rel=mask-icon href=https://mrdvince.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://mrdvince.github.io/posts/ckx8pdli806axz7s10sx5fy8c/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="Mime - A dummy Django, PyTorch project"><meta property="og:description" content="What is this?
This is me goofing around and trying to learn some Django the only way there is, (by attempting to build something and combining it with a bunch of other things I know or have come across).
About
This is a Django-based &ldquo;web app&rdquo; that uses a Densenet 121 model trained to classify 6 classes of objects.
The Classes

Potholes
Dumping
Accidents
Flooded
Bad drainage
Construction

Data
The data was got from Duckduck go using jmd_imagecraper"><meta property="og:type" content="article"><meta property="og:url" content="https://mrdvince.github.io/posts/ckx8pdli806axz7s10sx5fy8c/"><meta property="og:image" content="https://cdn.hashnode.com/res/hashnode/image/unsplash/m1dM7ZXvdMs/upload/v1639637434200/7xLR94FqX.jpeg?w=1600&amp;h=840&amp;fit=crop&amp;crop=entropy&amp;auto=compress,format&amp;format=webp"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-12-16T13:12:24+01:00"><meta property="article:modified_time" content="2021-12-16T13:12:24+01:00"><meta property="og:site_name" content="Nomadin"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://cdn.hashnode.com/res/hashnode/image/unsplash/m1dM7ZXvdMs/upload/v1639637434200/7xLR94FqX.jpeg?w=1600&amp;h=840&amp;fit=crop&amp;crop=entropy&amp;auto=compress,format&amp;format=webp"><meta name=twitter:title content="Mime - A dummy Django, PyTorch project"><meta name=twitter:description content="What is this?
This is me goofing around and trying to learn some Django the only way there is, (by attempting to build something and combining it with a bunch of other things I know or have come across).
About
This is a Django-based &ldquo;web app&rdquo; that uses a Densenet 121 model trained to classify 6 classes of objects.
The Classes

Potholes
Dumping
Accidents
Flooded
Bad drainage
Construction

Data
The data was got from Duckduck go using jmd_imagecraper"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://mrdvince.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Mime - A dummy Django, PyTorch project","item":"https://mrdvince.github.io/posts/ckx8pdli806axz7s10sx5fy8c/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Mime - A dummy Django, PyTorch project","name":"Mime - A dummy Django, PyTorch project","description":"What is this? This is me goofing around and trying to learn some Django the only way there is, (by attempting to build something and combining it with a bunch of other things I know or have come across).\nAbout This is a Django-based \u0026ldquo;web app\u0026rdquo; that uses a Densenet 121 model trained to classify 6 classes of objects.\nThe Classes Potholes Dumping Accidents Flooded Bad drainage Construction Data The data was got from Duckduck go using jmd_imagecraper\n","keywords":[],"articleBody":"What is this? This is me goofing around and trying to learn some Django the only way there is, (by attempting to build something and combining it with a bunch of other things I know or have come across).\nAbout This is a Django-based “web app” that uses a Densenet 121 model trained to classify 6 classes of objects.\nThe Classes Potholes Dumping Accidents Flooded Bad drainage Construction Data The data was got from Duckduck go using jmd_imagecraper\nSteps to replicate Install jmd_imagescraper. This is an image scraping library for creating deep learning datasets. Follow (this link)[https://github.com/joedockrill/jmd_imagescraper] to check out the Github repo.\nImports and download directory\nfrom jmd_imagescraper.core import * from pathlib import Path root = Path().cwd() / \"images\" This imports and the necessary packages needed and sets the image download directory to the images directory.\nThe directory gets automatically created so no need to worry about that.\nGetting some data These are the classes I was interested in at the time (for no reason at all, so no why) but can be used to get different image classes, just swap out the image names. mime = { 'Potholes':'road potholes', 'Dumping':'dump sites littering', 'Accidents':'road accident', 'Flooded':'flooded roads', 'Bad drainage':'bad drainages roads', \"Construction\", \"Road under construction, construction sites\", } for key, value in mime.items(): duckduckgo_search(root, key, value, max_results=120) The duckduckgo_search function takes in a directory, the name of the image folder, the value to search for and how many images do you want. Then searches for the images and downloads them, making using torchvision’s image folder a breeze, no writing custom data loaders, etc (unless you want to).\nData cleaning Another cool feature from this is the image cleaner. Just load the images and go through the classes and remove the images that don’t meet your criteria. Makes getting rid of unwanted images pretty easy. from jmd_imagescraper.imagecleaner import * display_image_cleaner(root) Training As this was trained on a simple small dataset (don’t get me wrong, the performance is pretty good), the generalization might not be that great.\nNow with that out of the way let’s look at some code snips.\nThe training repo All this can be found in this repo.\nSimply follow the getting started part of the README and you should be up running.\nThe data loader Since the different image classes are stored in their respective folders, we just use the folder names as the classes. Using torchvision’s image folder method makes this pretty straightforward.\n# The base class can be swapped with the `torch.utils.data.DataLoader` class class AjimeDataLoader(BaseDataLoader): \"\"\"AjimeDataLoader\"\"\" def __init__( self, data_dir, batch_size, shuffle=True, validation_split=0.2, num_workers=4, training=True, ): trsfm = transforms.Compose( [ transforms.Resize((224, 224)), transforms.ToTensor(), transforms.Normalize( mean=[0.485, 0.456, 0.406], std=[0.229, 0.224, 0.225] ), ] ) self.data_dir = data_dir self.dataset = datasets.ImageFolder(data_dir, transform=trsfm) super().__init__( self.dataset, batch_size, shuffle, validation_split, num_workers ) Load the data from the data directory, apply some transforms, and voila. Using a validation split of 20% percent of the data for the validation steps.\nIf using a CPU with less than 4 cores just set the num_workers to the number of your CPU cores.\nThe model The model used is a pretrained Densenet 121 model.\nWhy Densenet121? It’s never disappointed me, it’s small and pretty straightforward to work with. (Note: they are other better model architectures)\n# Densenet Model class AjimeModel(BaseModel): def __init__(self): super().__init__() self.model = torchvision.models.densenet121(pretrained=True) for param in self.model.features.parameters(): param.requires_grad = False self.model.classifier = nn.Sequential( nn.Linear(1024, 512), nn.Dropout(0.2), nn.ReLU(), nn.Linear(512, 6) ) def forward(self, x): return self.model(x) torchvision.models.densenet121(pretrained=True) is responsible for downloading the model.\nThen freeze the feature parameters, and replace the classifier with an output of 6 classes, and we are ready to train.\nThe training loop The training loop is just the usual vanilla PyTorch training loop as seen in this snip.\nfor batch_idx, (data, target) in enumerate(pbar): data, target = data.to(self.device), target.to(self.device) self.optimizer.zero_grad() output = self.model(data) loss = self.criterion(output, target) loss.backward() self.optimizer.step() self.writer.set_step((epoch - 1) * self.len_epoch + batch_idx) self.train_metrics.update(\"loss\", loss.item()) for met in self.metric_ftns: self.train_metrics.update(met.__name__, met(output, target)) if batch_idx % self.log_step == 0: pbar.set_postfix( { \"Train Epoch\": epoch, \"Train Loss\": loss.item(), } ) self.writer.add_image( \"input\", make_grid(data.cpu(), nrow=8, normalize=True) ) if batch_idx == self.len_epoch: break Some training logs:\n2021-12-12 12:49:45,955 - trainer - INFO - epoch : 14 2021-12-12 12:49:45,956 - trainer - INFO - loss : 0.2260482641203063 2021-12-12 12:49:45,956 - trainer - INFO - accuracy : 0.9285714285714286 2021-12-12 12:49:45,957 - trainer - INFO - top_k_acc : 1.0 2021-12-12 12:49:45,957 - trainer - INFO - val_loss : 0.8062299564480782 2021-12-12 12:49:45,958 - trainer - INFO - val_accuracy : 0.78125 2021-12-12 12:49:45,958 - trainer - INFO - val_top_k_acc : 0.953125 2021-12-12 12:49:46,146 - trainer - INFO - Saving checkpoint: saved/models/ajime/1212_124412/checkpoint-epoch14.pth ... 2021-12-12 12:49:46,390 - trainer - INFO - Saving current best: model_best.pth ... Deployment All the code for this is also in this repo simply follow the README to get you set up.\nUsing cookie-cutter Django for this was a bit overkill.\nGetting started Dependencies Docker and docker-compose For windows download docker desktop and that should get sorted out.\n# Linux # Download Docker curl -fsSL get.docker.com -o get-docker.sh # Install Docker using the stable channel (instead of the default \"edge\") CHANNEL=stable sh get-docker.sh # Remove Docker install script rm get-docker.sh # Docker compose sudo curl -L \"https://github.com/docker/compose/releases/download/1.29.2/docker-compose-$(uname -s)-$(uname -m)\" -o /usr/local/bin/docker-compose Clone the repository (if you haven’t already) Using recursive to include the submodule repo in the cloned directory.\ngit clone --recursive https://github.com/mrdvince/mime cd mime Running it Once cloned is done simply use docker to run it and everything should just work. The model is included in the ajime submodule, can be retrained or completely swapped out if needed.\n# This should get you up and running docker-compose -f local.yml up -d --build Settings Setting Up Your Users\nTo create a normal user account, just go to Sign Up and fill out\nTo create an superuser account, use this command:\npython manage.py createsuperuser Some screenshots ","wordCount":"973","inLanguage":"en","image":"https://cdn.hashnode.com/res/hashnode/image/unsplash/m1dM7ZXvdMs/upload/v1639637434200/7xLR94FqX.jpeg?w=1600\u0026h=840\u0026fit=crop\u0026crop=entropy\u0026auto=compress,format\u0026format=webp","datePublished":"2021-12-16T13:12:24+01:00","dateModified":"2021-12-16T13:12:24+01:00","author":{"@type":"Person","name":"Vince"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://mrdvince.github.io/posts/ckx8pdli806axz7s10sx5fy8c/"},"publisher":{"@type":"Organization","name":"Nomadin","logo":{"@type":"ImageObject","url":"https://mrdvince.github.io/favicon.ico"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://mrdvince.github.io/ accesskey=h title="Nomadin (Alt + H)">Nomadin</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://mrdvince.github.io/archives/ title=Blog><span>Blog</span></a></li><li><a href=https://mrdvince.github.io/about/ title=About><span>About</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">Mime - A dummy Django, PyTorch project</h1><div class=post-meta><span title='2021-12-16 13:12:24 +0100 CET'>December 16, 2021</span>&nbsp;·&nbsp;5 min&nbsp;·&nbsp;973 words&nbsp;·&nbsp;Vince</div></header><figure class=entry-cover><img loading=eager src="https://cdn.hashnode.com/res/hashnode/image/unsplash/m1dM7ZXvdMs/upload/v1639637434200/7xLR94FqX.jpeg?w=1600&amp;h=840&amp;fit=crop&amp;crop=entropy&amp;auto=compress,format&amp;format=webp" alt></figure><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#the-classes>The Classes</a></li></ul><ul><li><a href=#steps-to-replicate>Steps to replicate</a></li></ul><ul><li><a href=#the-training-repo>The training repo</a></li><li><a href=#the-data-loader>The data loader</a></li><li><a href=#the-model>The model</a><ul><li><a href=#why-densenet121>Why Densenet121?</a></li></ul></li><li><a href=#the-training-loop>The training loop</a></li></ul><ul><li><a href=#getting-started>Getting started</a><ul><li><a href=#dependencies>Dependencies</a></li></ul></li><li><a href=#settings>Settings</a></li><li><a href=#some-screenshots>Some screenshots</a></li></ul></nav></div></details></div><div class=post-content><h1 id=what-is-this>What is this?<a hidden class=anchor aria-hidden=true href=#what-is-this>#</a></h1><p>This is me goofing around and trying to learn some Django the only way there is, (by attempting to build something and combining it with a bunch of other things I know or have come across).</p><h1 id=about>About<a hidden class=anchor aria-hidden=true href=#about>#</a></h1><p>This is a Django-based &ldquo;web app&rdquo; that uses a Densenet 121 model trained to classify 6 classes of objects.</p><h2 id=the-classes>The Classes<a hidden class=anchor aria-hidden=true href=#the-classes>#</a></h2><ul><li>Potholes</li><li>Dumping</li><li>Accidents</li><li>Flooded</li><li>Bad drainage</li><li>Construction</li></ul><h1 id=data>Data<a hidden class=anchor aria-hidden=true href=#data>#</a></h1><p>The data was got from Duckduck go using jmd_imagecraper</p><h2 id=steps-to-replicate>Steps to replicate<a hidden class=anchor aria-hidden=true href=#steps-to-replicate>#</a></h2><ul><li><p>Install <code>jmd_imagescraper</code>. This is an image scraping library for creating deep learning datasets.
Follow (this link)[https://github.com/joedockrill/jmd_imagescraper] to check out the Github repo.</p></li><li><p>Imports and download directory</p></li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>jmd_imagescraper.core</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pathlib</span> <span class=kn>import</span> <span class=n>Path</span>
</span></span><span class=line><span class=cl><span class=n>root</span> <span class=o>=</span> <span class=n>Path</span><span class=p>()</span><span class=o>.</span><span class=n>cwd</span><span class=p>()</span> <span class=o>/</span> <span class=s2>&#34;images&#34;</span>
</span></span></code></pre></div><p>This imports and the necessary packages needed and sets the image download directory to the images directory.</p><blockquote><p>The directory gets automatically created so no need to worry about that.</p></blockquote><ul><li>Getting some data
These are the classes I was interested in at the time (for no reason at all, so no why) but can be used to get different image classes, just swap out the image names.</li></ul><pre tabindex=0><code>mime = {
    &#39;Potholes&#39;:&#39;road potholes&#39;,
    &#39;Dumping&#39;:&#39;dump sites littering&#39;,
    &#39;Accidents&#39;:&#39;road accident&#39;,
    &#39;Flooded&#39;:&#39;flooded roads&#39;,
    &#39;Bad drainage&#39;:&#39;bad drainages roads&#39;,
    &#34;Construction&#34;, &#34;Road under construction, construction sites&#34;,
}
for key, value in mime.items():
    duckduckgo_search(root, key, value, max_results=120)
</code></pre><p>The duckduckgo_search function takes in a directory, the name of the image folder, the value to search for and how many images do you want.
Then searches for the images and downloads them, making using torchvision&rsquo;s image folder a breeze, no writing custom data loaders, etc (unless you want to).</p><ul><li>Data cleaning
Another cool feature from this is the image cleaner. Just load the images and go through the classes and remove the images that don&rsquo;t meet your criteria. Makes getting rid of unwanted images pretty easy.</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>jmd_imagescraper.imagecleaner</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>display_image_cleaner</span><span class=p>(</span><span class=n>root</span><span class=p>)</span>
</span></span></code></pre></div><h1 id=training>Training<a hidden class=anchor aria-hidden=true href=#training>#</a></h1><blockquote><p>As this was trained on a simple small dataset (don&rsquo;t get me wrong, the performance is pretty good), the generalization might not be that great.</p></blockquote><p>Now with that out of the way let&rsquo;s look at some code snips.</p><h2 id=the-training-repo>The training repo<a hidden class=anchor aria-hidden=true href=#the-training-repo>#</a></h2><p>All this can be found in <a href=https://github.com/mrdvince/ajime>this repo</a>.</p><p>Simply follow the getting started part of the <code>README</code> and you should be up running.</p><h2 id=the-data-loader>The data loader<a hidden class=anchor aria-hidden=true href=#the-data-loader>#</a></h2><p>Since the different image classes are stored in their respective folders, we just use the folder names as the classes.
Using torchvision&rsquo;s image folder method makes this pretty straightforward.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># The base class can be swapped with the `torch.utils.data.DataLoader` class</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>AjimeDataLoader</span><span class=p>(</span><span class=n>BaseDataLoader</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;AjimeDataLoader&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>data_dir</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>batch_size</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>shuffle</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>validation_split</span><span class=o>=</span><span class=mf>0.2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>num_workers</span><span class=o>=</span><span class=mi>4</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>training</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>trsfm</span> <span class=o>=</span> <span class=n>transforms</span><span class=o>.</span><span class=n>Compose</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=p>[</span>
</span></span><span class=line><span class=cl>                <span class=n>transforms</span><span class=o>.</span><span class=n>Resize</span><span class=p>((</span><span class=mi>224</span><span class=p>,</span> <span class=mi>224</span><span class=p>)),</span>
</span></span><span class=line><span class=cl>                <span class=n>transforms</span><span class=o>.</span><span class=n>ToTensor</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>                <span class=n>transforms</span><span class=o>.</span><span class=n>Normalize</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                    <span class=n>mean</span><span class=o>=</span><span class=p>[</span><span class=mf>0.485</span><span class=p>,</span> <span class=mf>0.456</span><span class=p>,</span> <span class=mf>0.406</span><span class=p>],</span> <span class=n>std</span><span class=o>=</span><span class=p>[</span><span class=mf>0.229</span><span class=p>,</span> <span class=mf>0.224</span><span class=p>,</span> <span class=mf>0.225</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                <span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>data_dir</span> <span class=o>=</span> <span class=n>data_dir</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>dataset</span> <span class=o>=</span> <span class=n>datasets</span><span class=o>.</span><span class=n>ImageFolder</span><span class=p>(</span><span class=n>data_dir</span><span class=p>,</span> <span class=n>transform</span><span class=o>=</span><span class=n>trsfm</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>dataset</span><span class=p>,</span> <span class=n>batch_size</span><span class=p>,</span> <span class=n>shuffle</span><span class=p>,</span> <span class=n>validation_split</span><span class=p>,</span> <span class=n>num_workers</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span></code></pre></div><p>Load the data from the data directory, apply some transforms, and voila. Using a validation split of 20% percent of the data for the validation steps.</p><blockquote><p>If using a CPU with less than 4 cores just set the <code>num_workers</code> to the number of your CPU cores.</p></blockquote><h2 id=the-model>The model<a hidden class=anchor aria-hidden=true href=#the-model>#</a></h2><p>The model used is a pretrained Densenet 121 model.</p><h3 id=why-densenet121>Why Densenet121?<a hidden class=anchor aria-hidden=true href=#why-densenet121>#</a></h3><p>It&rsquo;s never disappointed me, it&rsquo;s small and pretty straightforward to work with. (Note: they are other better model architectures)</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># Densenet Model</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>AjimeModel</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>model</span> <span class=o>=</span> <span class=n>torchvision</span><span class=o>.</span><span class=n>models</span><span class=o>.</span><span class=n>densenet121</span><span class=p>(</span><span class=n>pretrained</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>param</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>model</span><span class=o>.</span><span class=n>features</span><span class=o>.</span><span class=n>parameters</span><span class=p>():</span>
</span></span><span class=line><span class=cl>            <span class=n>param</span><span class=o>.</span><span class=n>requires_grad</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>model</span><span class=o>.</span><span class=n>classifier</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>Sequential</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>nn</span><span class=o>.</span><span class=n>Linear</span><span class=p>(</span><span class=mi>1024</span><span class=p>,</span> <span class=mi>512</span><span class=p>),</span> <span class=n>nn</span><span class=o>.</span><span class=n>Dropout</span><span class=p>(</span><span class=mf>0.2</span><span class=p>),</span> <span class=n>nn</span><span class=o>.</span><span class=n>ReLU</span><span class=p>(),</span> <span class=n>nn</span><span class=o>.</span><span class=n>Linear</span><span class=p>(</span><span class=mi>512</span><span class=p>,</span> <span class=mi>6</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>forward</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>x</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>model</span><span class=p>(</span><span class=n>x</span><span class=p>)</span>
</span></span></code></pre></div><p><code>torchvision.models.densenet121(pretrained=True)</code> is responsible for downloading the model.</p><p>Then freeze the feature parameters, and replace the classifier with an output of 6 classes, and we are ready to train.</p><h2 id=the-training-loop>The training loop<a hidden class=anchor aria-hidden=true href=#the-training-loop>#</a></h2><p>The training loop is just the usual vanilla PyTorch training loop as seen in this snip.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl> <span class=k>for</span> <span class=n>batch_idx</span><span class=p>,</span> <span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=n>target</span><span class=p>)</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>pbar</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>data</span><span class=p>,</span> <span class=n>target</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>to</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>device</span><span class=p>),</span> <span class=n>target</span><span class=o>.</span><span class=n>to</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>device</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>optimizer</span><span class=o>.</span><span class=n>zero_grad</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>output</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>model</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>loss</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>criterion</span><span class=p>(</span><span class=n>output</span><span class=p>,</span> <span class=n>target</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>loss</span><span class=o>.</span><span class=n>backward</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>optimizer</span><span class=o>.</span><span class=n>step</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>writer</span><span class=o>.</span><span class=n>set_step</span><span class=p>((</span><span class=n>epoch</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)</span> <span class=o>*</span> <span class=bp>self</span><span class=o>.</span><span class=n>len_epoch</span> <span class=o>+</span> <span class=n>batch_idx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>train_metrics</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=s2>&#34;loss&#34;</span><span class=p>,</span> <span class=n>loss</span><span class=o>.</span><span class=n>item</span><span class=p>())</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>met</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>metric_ftns</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>train_metrics</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=n>met</span><span class=o>.</span><span class=vm>__name__</span><span class=p>,</span> <span class=n>met</span><span class=p>(</span><span class=n>output</span><span class=p>,</span> <span class=n>target</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>batch_idx</span> <span class=o>%</span> <span class=bp>self</span><span class=o>.</span><span class=n>log_step</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>pbar</span><span class=o>.</span><span class=n>set_postfix</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                    <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;Train Epoch&#34;</span><span class=p>:</span> <span class=n>epoch</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;Train Loss&#34;</span><span class=p>:</span> <span class=n>loss</span><span class=o>.</span><span class=n>item</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>                    <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>writer</span><span class=o>.</span><span class=n>add_image</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;input&#34;</span><span class=p>,</span> <span class=n>make_grid</span><span class=p>(</span><span class=n>data</span><span class=o>.</span><span class=n>cpu</span><span class=p>(),</span> <span class=n>nrow</span><span class=o>=</span><span class=mi>8</span><span class=p>,</span> <span class=n>normalize</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>batch_idx</span> <span class=o>==</span> <span class=bp>self</span><span class=o>.</span><span class=n>len_epoch</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span>
</span></span></code></pre></div><p>Some training logs:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>2021-12-12 12:49:45,955 - trainer - INFO -     epoch          : <span class=m>14</span>
</span></span><span class=line><span class=cl>2021-12-12 12:49:45,956 - trainer - INFO -     loss           : 0.2260482641203063
</span></span><span class=line><span class=cl>2021-12-12 12:49:45,956 - trainer - INFO -     accuracy       : 0.9285714285714286
</span></span><span class=line><span class=cl>2021-12-12 12:49:45,957 - trainer - INFO -     top_k_acc      : 1.0
</span></span><span class=line><span class=cl>2021-12-12 12:49:45,957 - trainer - INFO -     val_loss       : 0.8062299564480782
</span></span><span class=line><span class=cl>2021-12-12 12:49:45,958 - trainer - INFO -     val_accuracy   : 0.78125
</span></span><span class=line><span class=cl>2021-12-12 12:49:45,958 - trainer - INFO -     val_top_k_acc  : 0.953125
</span></span><span class=line><span class=cl>2021-12-12 12:49:46,146 - trainer - INFO - Saving checkpoint: saved/models/ajime/1212_124412/checkpoint-epoch14.pth ...
</span></span><span class=line><span class=cl>2021-12-12 12:49:46,390 - trainer - INFO - Saving current best: model_best.pth ...
</span></span></code></pre></div><h1 id=deployment>Deployment<a hidden class=anchor aria-hidden=true href=#deployment>#</a></h1><p>All the code for this is also in <a href=https://github.com/mrdvince/mime>this repo</a> simply follow the <code>README</code> to get you set up.</p><blockquote><p>Using cookie-cutter Django for this was a bit overkill.</p></blockquote><h2 id=getting-started>Getting started<a hidden class=anchor aria-hidden=true href=#getting-started>#</a></h2><h3 id=dependencies>Dependencies<a hidden class=anchor aria-hidden=true href=#dependencies>#</a></h3><ul><li>Docker and docker-compose</li></ul><p>For windows download docker desktop and that should get sorted out.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># Linux</span>
</span></span><span class=line><span class=cl><span class=c1># Download Docker</span>
</span></span><span class=line><span class=cl>curl -fsSL get.docker.com -o get-docker.sh
</span></span><span class=line><span class=cl><span class=c1># Install Docker using the stable channel (instead of the default &#34;edge&#34;)</span>
</span></span><span class=line><span class=cl><span class=nv>CHANNEL</span><span class=o>=</span>stable sh get-docker.sh
</span></span><span class=line><span class=cl><span class=c1># Remove Docker install script</span>
</span></span><span class=line><span class=cl>rm get-docker.sh
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Docker compose</span>
</span></span><span class=line><span class=cl>sudo curl -L <span class=s2>&#34;https://github.com/docker/compose/releases/download/1.29.2/docker-compose-</span><span class=k>$(</span>uname -s<span class=k>)</span><span class=s2>-</span><span class=k>$(</span>uname -m<span class=k>)</span><span class=s2>&#34;</span> -o /usr/local/bin/docker-compose
</span></span></code></pre></div><ul><li>Clone the repository (if you haven&rsquo;t already)</li></ul><p>Using recursive to include the submodule repo in the cloned directory.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>git clone --recursive https://github.com/mrdvince/mime
</span></span><span class=line><span class=cl><span class=nb>cd</span> mime
</span></span></code></pre></div><ul><li>Running it</li></ul><p>Once cloned is done simply use docker to run it and everything should just work.
The model is included in the ajime submodule, can be retrained or completely swapped out if needed.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># This should get you up and running</span>
</span></span><span class=line><span class=cl>docker-compose -f local.yml up -d --build
</span></span></code></pre></div><h2 id=settings>Settings<a hidden class=anchor aria-hidden=true href=#settings>#</a></h2><p>Setting Up Your Users</p><ul><li><p>To create a normal user account, just go to Sign Up and fill out</p></li><li><p>To create an superuser account, use this command:</p></li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>python manage.py createsuperuser
</span></span></code></pre></div><h2 id=some-screenshots>Some screenshots<a hidden class=anchor aria-hidden=true href=#some-screenshots>#</a></h2><p><img loading=lazy src=https://cdn.hashnode.com/res/hashnode/image/upload/v1639642165523/RctneLKx5.png alt=lp.png></p><p><img loading=lazy src=https://cdn.hashnode.com/res/hashnode/image/upload/v1639642136459/D0VGGYbtx.png alt=inf.png></p></div><footer class=post-footer><ul class=post-tags></ul><nav class=paginav><a class=prev href=https://mrdvince.github.io/posts/cldhwjgi3000209ld6fgh6j0l/><span class=title>« Prev</span><br><span>Rust Basics: Taking the First Steps</span>
</a><a class=next href=https://mrdvince.github.io/posts/ckvmevbpz0mwg7ls1hbs99s69/><span class=title>Next »</span><br><span>Nebo - Build and Deploy(API as a Service)</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://mrdvince.github.io/>Nomadin</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>